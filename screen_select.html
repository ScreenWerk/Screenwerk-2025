<!-- 
 0. disclaimer 
   - no 3rd-party tools like jQuery
   - avoid using unnecessary semicolon
 1. fetch all available screen groups and screens from 
      @hostname=entu.app/api
      @account=piletilevi
    with request
      GET {{hostname}}/{{account}}/entity?_type.string=sw_screen HTTP/1.1
          Accept-Encoding: deflate
    with response
      {
        "entities": [
          {
            "_id": "510381f94ecca5c17a599cbf",
            "_parent": [
              {
                "_id": "510381f94ecca5c17a635660",
                "reference": "510383194ecca5c17a59a116",
                "string": "Maxima"
              }
            ],
            "_sharing": [
              {
                "_id": "665607054ecca5c17a636d3d",
                "string": "public"
              }
            ],
            "_type": [
              {
                "_id": "510381f94ecca5c17a635661",
                "reference": "665606334ecca5c17a59aa63",
                "string": "sw_screen"
              }
            ]
          },
          ...
        }

 2. display the list grouped by _parent.string
 3. save selected screen to local storage
 -->
<html>
  <head>
    <title>Screen Select</title>
    <script>
      const SCREENWERK_PUBLISHER_API = 'https://swpublisher.entu.eu/screen/' // append screen ID to load configuration
      const hostname = 'entu.app/api'
      const account = 'piletilevi'
      const url = `https://${hostname}/${account}/entity?_type.string=sw_screen&props=name.string,screen_group,published.string&sort=name.string&limit=10000`
      
      
      async function fetchScreenGroups() {
        const screenGroupList_E = document.getElementById('screen-group-list')
        const response = await fetch(url)
        const data = await response.json()
        const entities = data.entities
        console.log(`fetched ${data.limit}/${data.count} screens`)
        console.log(data)
        const screenGroups = {}
        data.entities.forEach(screen => {
          if (screen.screen_group && screen.screen_group.length > 0) {
            const groupName = screen.screen_group[0].string
            if (!screenGroups[groupName]) {
              screenGroups[groupName] = ''
              const newGroupItem = document.createElement('li')
              const newScreenItems = document.createElement('ul')
              newGroupItem.id = screen.screen_group[0].reference
              newGroupItem.className = 'pending'

              newGroupItem.appendChild(newScreenItems)
              newGroupItem.textContent = groupName
              screenGroupList_E.appendChild(newGroupItem)
            }
            const groupItem = document.getElementById(screen.screen_group[0].reference)
            const screenItems = groupItem.querySelector('ul')
            const screenItem = document.createElement('li')
            screenItem.id = screen._id
            screenItem.className = 'pending'

            screenItem.textContent = screen.name[0].string
            screenItem.addEventListener('click', () => {
              localStorage.setItem('selectedScreen', JSON.stringify(screen))
              window.location.href = 'index.html'
            })
            screenItems.appendChild(screenItem)
          } else {
            console.log(`screen ${screen._id}, ${screen.name[0].string} has no screen_group`)
          }
        })
        return entities
      }

      window.onload = async function () {
        const screens = await fetchScreenGroups()
        // load configurations from publisher API
        for (const screen of screens) {
          const screenItem = document.getElementById(screen._id)
          const response = await fetch(SCREENWERK_PUBLISHER_API + screen._id)
          const data = await response.json()
          console.log(`screen ${screen._id} published at ${screen.published[0].string}`)
          screenItem.className = 'loaded'
        }
      }
    </script>
  </head>
  <body>
    <h1>Select Screen</h1>
    <ul id="screen-group-list"></ul>
  </body>
</html>