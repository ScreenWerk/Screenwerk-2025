<!-- 
 0. disclaimer 
   - no 3rd-party tools like jQuery
   - avoid using unnecessary semicolon
 1. fetch all available screen groups and screens from 
      @hostname=entu.app/api
      @account=piletilevi
    with request
      GET {{hostname}}/{{account}}/entity?_type.string=sw_screen HTTP/1.1
          Accept-Encoding: deflate
    with response
      {
        "entities": [
          {
            "_id": "510381f94ecca5c17a599cbf",
            "_parent": [
              {
                "_id": "510381f94ecca5c17a635660",
                "reference": "510383194ecca5c17a59a116",
                "string": "Maxima"
              }
            ],
            "_sharing": [
              {
                "_id": "665607054ecca5c17a636d3d",
                "string": "public"
              }
            ],
            "_type": [
              {
                "_id": "510381f94ecca5c17a635661",
                "reference": "665606334ecca5c17a59aa63",
                "string": "sw_screen"
              }
            ]
          },
          ...
        }

 2. display the list grouped by _parent.string
 3. save selected screen to local storage
 -->
<html>
  <head>
    <title>Screen Select</title>
    <!-- style -->
    <link href="style.css" rel="stylesheet">
    <script>
      const SCREENWERK_PUBLISHER_API = 'https://swpublisher.entu.eu/screen/' // append screen ID (.json) to load configuration
      const HOSTNAME = 'entu.app/api'
      const ACCOUNT = 'piletilevi'
      const ENTU_SCREENS_URL = `https://${HOSTNAME}/${ACCOUNT}/entity?_type.string=sw_screen&props=name.string,screen_group,published.string&sort=name.string&limit=10000`
      const ENTU_ENTITY_URL = `https://${HOSTNAME}/${ACCOUNT}/entity`

      var sgList, sgIter
      
      class Iterable {
        constructor(seed_array) {
          //adding items to an array
          this.items = [].concat(seed_array || [])
        }
        // pushing an item to the array
        add(item) {
          this.items.push(item)
        }
        // report count of items
        get count() {
          return this.items.length
        }
        // report, if there are items left
        get hasItems() {
          return this.items.length > 0
        }
        
        //implement iterator function
        [Symbol.iterator](){
          let items = this.items
          return {
            next: async function() {
              async function fetchFromPublisher(screen_id) {
                const u = SCREENWERK_PUBLISHER_API + screen_id + '.json'
                const r = await fetch(u)
                if (r.status === 200) {
                  return await r.json()
                }
                else return false
              }
              async function fetchFromEntu(screen_id) {
                const u = `${ENTU_ENTITY_URL}/${screen_id}`
                const r = await fetch(u)
                return await r.json()
              }
              //retrieving an item from the array
              if (items.length) {
                const item = items.shift()
                const screen_id = item.screen_id
                const screengroup_id = item.screengroup_id
                  return {
                    value: {
                      screengroup_id: screengroup_id,
                      swpublisher: await fetchFromPublisher(screen_id),
                      entu_screengroup: await fetchFromEntu(screengroup_id)
                    },
                    done: false
                  }
              }
              //return true if all items are iterated
              return { done:true }
            }
          }
        }
      }

      function toDateTimeString(ISODate) {
        return ISODate.slice(0, 10) + '\n' + ISODate.slice(11, 19)
      }

      // async function fetchScreenGroup(id) {}

      async function fetchScreenGroups() {
        const sgList = new Iterable([])

        const screen_group_list_E = document.getElementById('screen-group-list')
        const response = await fetch(ENTU_SCREENS_URL)
        const data = await response.json()
        console.log(`fetched ${data.limit}/${data.count} screens`)
        const entities = data.entities
        console.log(entities)

        const screen_group_ids = []
        const selected_screen = JSON.parse(localStorage.getItem('selected_screen') || '{}')
        console.log(`selected screen: ${selected_screen}`)
        entities.forEach(async screen => {
          if (screen.screen_group && screen.screen_group.length > 0) {
            const group_name = screen.screen_group[0].string
            const group_id = screen.screen_group[0].reference

            // if new group, register it
            if (!screen_group_ids.includes(group_id)) {
              screen_group_ids.push(group_id)
              
              // also enqueue the group for configuration retrieval
              // const newScreenGroup = await fetchScreenGroup(groupId)
              // console.log(`new group: ${groupName} from Entu:`, newScreenGroup)
              sgList.add({
                screen_id: screen._id,
                screengroup_id: group_id
              })

              const new_group_item = document.createElement('li')
              new_group_item.id = group_id
              new_group_item.className = 'screen-group'
              
              new_group_item.textContent = group_name

              const published_element = document.createElement('div')
              published_element.id = 'dates'
              new_group_item.appendChild(published_element)

              const entu_published_element = document.createElement('pre')
              entu_published_element.id = 'ePublished'
              published_element.appendChild(entu_published_element)
              // entuPublishedElement.textContent = 'Entu: ' + toDateTimeString(screen.published[0].string)

              const sw_published_element = document.createElement('pre')
              sw_published_element.id = 'swPublished'
              published_element.appendChild(sw_published_element)
              // localPublishedElement.textContent = 'Local: '

              const new_screen_items = document.createElement('ul')
              new_group_item.appendChild(new_screen_items)
              screen_group_list_E.appendChild(new_group_item)
            }
            const group_item = document.getElementById(group_id)
            const screen_items = group_item.querySelector('ul')
            const screen_item = document.createElement('li')


            screen_item.id = screen._id
            screen_item.className = 'screen-item on-hover'
            if (selected_screen._id === screen._id) {
              screen_item.classList.add('active')
            }

            screen_item.textContent = screen.name[0].string

            const status_element = document.createElement('span')
            status_element.id = 'status'
            screen_item.appendChild(status_element)

            screen_item.addEventListener('click', () => {
              localStorage.setItem('selected_screen', JSON.stringify(screen))
              window.location.href = 'index.html'
            })
            screen_items.appendChild(screen_item)
          } else {
            console.log(`screen ${screen._id}, ${screen.name[0].string} has no screen_group`)
          }
        })
        return sgList
      }

      window.onload = async function () {
        sgList = await fetchScreenGroups()
        sgIter = sgList[Symbol.iterator]()

        // screengrouploop:
        while (true) {
          const next = (await sgIter.next())
          // console.log(next)
          if (next.done) break
          
          const screengroup_id = next.value.screengroup_id
          // console.log(`Update dates for ${screengroup_id}`)
          const screengroup_item = document.getElementById(screengroup_id)
          if (screengroup_item) {
            const entu_pub_date = next.value.entu_screengroup.entity.published[0].datetime
            // console.log(entuPubDate)
            if (entu_pub_date) {
              const entu_pub_date_E = screengroup_item.querySelector('#ePublished')
              entu_pub_date_E.textContent = 'Entu: ' + toDateTimeString(entu_pub_date)
            }

            if (next.value.swpublisher) {
              const swpublisher_pub_date = next.value.swpublisher.publishedAt
              const swpublisher_pub_date_E = screengroup_item.querySelector('#swPublished')
              swpublisher_pub_date_E.textContent = 'SWPublisher: ' + toDateTimeString(swpublisher_pub_date)
            }
          } else {
            null
          }
        }
      }
    </script>
  </head>
  <body>
    <h1>Select Screen</h1>
    <ul id="screen-group-list"></ul>
  </body>
</html>