<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clean Player Architecture Demo - Phase 1: Real API Integration</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f0f0f0;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header {
            background: linear-gradient(45deg, #FF6B35, #F7931E);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        .api-status {
            background: #e3f2fd;
            border: 2px solid #2196F3;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 14px;
        }
        .controls {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 10px 0;
        }
        input[type="text"] {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
            width: 300px;
        }
        button {
            padding: 10px 15px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            background: #FF6B35;
            color: white;
            font-size: 14px;
            font-weight: bold;
        }
        button:hover {
            background: #E55A2B;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
        .player-container {
            width: 800px;
            height: 450px;
            background: #000;
            border: 2px solid #333;
            margin: 20px 0;
            position: relative;
        }
        .log {
            background: #f8f8f8;
            border: 1px solid #ddd;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
            font-size: 12px;
        }
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .info-section {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 8px;
        }
        .info-section h3 {
            margin-top: 0;
            color: #2196F3;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Phase 1: Real API Integration Demo</h1>
            <p>Testing ScreenWerk Publisher API ‚Üí Player pipeline</p>
            <p><small>Enhanced with live configuration loading and data transformation</small></p>
        </div>

        <div class="api-status" id="apiStatus">
            üåê Ready to test with live ScreenWerk Publisher API
        </div>

        <div class="input-group">
            <label for="screenIdInput"><strong>Screen ID:</strong></label>
            <input type="text" id="screenIdInput" value="5799c2744ecca5c17a599ecd" placeholder="Enter 24-character screen ID">
            <button id="fetchConfigBtn">üì° Fetch Live Config</button>
        </div>

        <div class="controls">
            <button id="initBtn" disabled>Initialize Player + Scheduler</button>
            <button id="startSchedulerBtn" disabled>üîÑ Start Scheduler</button>
            <button id="evaluateBtn" disabled>‚ö° Evaluate Schedules</button>
            <button id="playBtn" disabled>‚ñ∂Ô∏è Play</button>
            <button id="pauseBtn" disabled>‚è∏Ô∏è Pause</button>
            <button id="stopSchedulerBtn" disabled>‚èπÔ∏è Stop Scheduler</button>
            <button id="destroyBtn" disabled>üí• Destroy All</button>
            <button id="clearLogBtn">üßπ Clear Log</button>
        </div>

        <div class="status" id="status">
            Ready to fetch live configuration from ScreenWerk API...
        </div>

        <!-- Player Container -->
        <div class="player-container" id="playerContainer">
            <div style="color: white; text-align: center; padding: 50px; background: rgba(0,0,0,0.1);">
                üé¨ Player will render live content here
            </div>
        </div>

        <div class="info-grid">
            <div class="info-section">
                <h3>üéÆ Player State:</h3>
                <div id="playerState" class="status">Not initialized</div>
            </div>
            
            <div class="info-section">
                <h3>‚è∞ Scheduler State:</h3>
                <div id="schedulerState" class="status">Not initialized</div>
            </div>
        </div>

        <div class="info-section">
            <h3>üìä Configuration Data:</h3>
            <div id="configData" class="status">No configuration loaded</div>
        </div>

        <div class="info-section">
            <h3>Debug Log:</h3>
            <div id="debugLog" class="log"></div>
        </div>
    </div>

    <script type="module">
        // Enable debug mode for testing
        window.debugMode = true
        
        // Import our clean classes
        import { ScreenWerkPlayer } from './js/core/Player.js'
        import { LayoutScheduler } from './js/core/Scheduler.js'
        import { SCREENWERK_PUBLISHER_API } from '../common/config/constants.js'
        
        let player = null
        let scheduler = null
        let currentConfiguration = null
        
        // DOM elements
        const screenIdInput = document.getElementById('screenIdInput')
        const fetchConfigBtn = document.getElementById('fetchConfigBtn')
        const initBtn = document.getElementById('initBtn')
        const startSchedulerBtn = document.getElementById('startSchedulerBtn')
        const evaluateBtn = document.getElementById('evaluateBtn')
        const playBtn = document.getElementById('playBtn')
        const pauseBtn = document.getElementById('pauseBtn')
        const stopSchedulerBtn = document.getElementById('stopSchedulerBtn')
        const destroyBtn = document.getElementById('destroyBtn')
        const clearLogBtn = document.getElementById('clearLogBtn')
        const statusDiv = document.getElementById('status')
        const apiStatusDiv = document.getElementById('apiStatus')
        const playerContainer = document.getElementById('playerContainer')
        const playerStateDiv = document.getElementById('playerState')
        const schedulerStateDiv = document.getElementById('schedulerState')
        const configDataDiv = document.getElementById('configData')
        const debugLogDiv = document.getElementById('debugLog')
        
        // Capture console output for display
        const originalLog = console.log
        const originalError = console.error
        
        function addToLog(message, isError = false) {
            const timestamp = new Date().toLocaleTimeString()
            const prefix = isError ? '‚ùå ERROR: ' : 'üìù '
            debugLogDiv.textContent += `[${timestamp}] ${prefix}${message}\n`
            debugLogDiv.scrollTop = debugLogDiv.scrollHeight
        }
        
        // Route console output to log
        console.log = function(...args) {
            originalLog.apply(console, args)
            addToLog(args.join(' '))
        }
        
        console.error = function(...args) {
            originalError.apply(console, args)
            addToLog(args.join(' '), true)
        }

        // Update status displays
        function updateStatus() {
            if (player) {
                const playerState = player.getState()
                playerStateDiv.innerHTML = `
                    Playing: ${playerState.isPlaying ? '‚úÖ' : '‚ùå'}<br>
                    Layout: ${playerState.currentLayout || 'None'}<br>
                    Regions: ${playerState.regionCount}<br>
                    Status: ${playerState.destroyed ? 'Destroyed' : 'Active'}
                `
            }
            
            if (scheduler) {
                const schedulerState = scheduler.getState()
                schedulerStateDiv.innerHTML = `
                    Running: ${schedulerState.isRunning ? '‚úÖ' : '‚ùå'}<br>
                    Config ID: ${schedulerState.configurationId}<br>
                    Current Layout: ${schedulerState.currentLayoutId || 'None'}<br>
                    Status: ${schedulerState.destroyed ? 'Destroyed' : 'Active'}
                `
            }
        }

        // Fetch configuration from API
        async function fetchConfiguration() {
            const screenId = screenIdInput.value.trim()
            
            if (!/^[0-9a-f]{24}$/.test(screenId)) {
                alert('Please enter a valid 24-character screen ID')
                return
            }

            try {
                statusDiv.textContent = 'üì° Fetching configuration from ScreenWerk API...'
                apiStatusDiv.innerHTML = `üîÑ Fetching from: ${SCREENWERK_PUBLISHER_API}${screenId}.json`
                
                const response = await fetch(`${SCREENWERK_PUBLISHER_API}${screenId}.json`)
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status} ${response.statusText}`)
                }
                
                currentConfiguration = await response.json()
                
                // Display configuration info
                configDataDiv.innerHTML = `
                    <strong>Config ID:</strong> ${currentConfiguration.configurationEid}<br>
                    <strong>Schedules:</strong> ${currentConfiguration.schedules?.length || 0}<br>
                    <strong>Update Interval:</strong> ${currentConfiguration.updateInterval} min<br>
                    <strong>Published:</strong> ${currentConfiguration.publishedAt}<br>
                    <details style="margin-top: 10px;">
                        <summary>Raw JSON Data</summary>
                        <pre style="font-size: 11px; max-height: 200px; overflow-y: auto;">${JSON.stringify(currentConfiguration, null, 2)}</pre>
                    </details>
                `
                
                statusDiv.textContent = '‚úÖ Configuration loaded! Ready to initialize Player + Scheduler'
                apiStatusDiv.innerHTML = `‚úÖ Live configuration loaded: ${currentConfiguration.schedules?.length || 0} schedules found`
                
                // Enable initialization
                initBtn.disabled = false
                
                console.log('‚úÖ Configuration fetched successfully')
                console.log(`üìä Config details: ${currentConfiguration.schedules?.length || 0} schedules, update interval: ${currentConfiguration.updateInterval}min`)
                
            } catch (error) {
                console.error('Failed to fetch configuration:', error)
                statusDiv.textContent = `‚ùå Failed to fetch configuration: ${error.message}`
                apiStatusDiv.innerHTML = `‚ùå API Error: ${error.message}`
                configDataDiv.textContent = 'Configuration fetch failed'
            }
        }

        // Initialize Player and Scheduler
        function initializeComponents() {
            try {
                statusDiv.textContent = 'üîß Initializing Player and Scheduler...'
                
                // Create Player
                player = new ScreenWerkPlayer(playerContainer)
                console.log('‚úÖ Player initialized')
                
                // Create Scheduler with callback
                scheduler = new LayoutScheduler({
                    configurationId: screenIdInput.value.trim(),
                    onLayoutChange: (layout) => {
                        console.log('üîÑ Scheduler requesting layout change:', layout.name)
                        player.loadLayout(layout)
                        updateStatus()
                    }
                })
                console.log('‚úÖ Scheduler initialized')
                
                statusDiv.textContent = '‚úÖ Player and Scheduler initialized! Ready to start.'
                
                // Enable controls
                startSchedulerBtn.disabled = false
                playBtn.disabled = false
                pauseBtn.disabled = false
                destroyBtn.disabled = false
                
                updateStatus()
                
            } catch (error) {
                console.error('Initialization failed:', error)
                statusDiv.textContent = `‚ùå Initialization failed: ${error.message}`
            }
        }

        // Start Scheduler
        async function startScheduler() {
            try {
                statusDiv.textContent = 'üöÄ Starting Scheduler...'
                await scheduler.start()
                
                statusDiv.textContent = '‚úÖ Scheduler started! Evaluating schedules...'
                
                startSchedulerBtn.disabled = true
                evaluateBtn.disabled = false
                stopSchedulerBtn.disabled = false
                
                updateStatus()
                
            } catch (error) {
                console.error('Failed to start scheduler:', error)
                statusDiv.textContent = `‚ùå Scheduler start failed: ${error.message}`
            }
        }

        // Manual schedule evaluation
        function evaluateSchedules() {
            if (scheduler) {
                console.log('‚ö° Manual schedule evaluation triggered')
                scheduler.evaluateSchedules()
                updateStatus()
            }
        }

        // Player controls
        function playPlayer() {
            if (player) {
                player.play()
                console.log('‚ñ∂Ô∏è Player play triggered')
                updateStatus()
            }
        }

        function pausePlayer() {
            if (player) {
                player.pause()
                console.log('‚è∏Ô∏è Player pause triggered')
                updateStatus()
            }
        }

        // Stop Scheduler
        function stopScheduler() {
            if (scheduler) {
                scheduler.stop()
                console.log('‚èπÔ∏è Scheduler stopped')
                
                startSchedulerBtn.disabled = false
                evaluateBtn.disabled = true
                stopSchedulerBtn.disabled = true
                
                updateStatus()
            }
        }

        // Destroy everything
        function destroyAll() {
            if (player) {
                player.destroy()
                player = null
                console.log('üí• Player destroyed')
            }
            
            if (scheduler) {
                scheduler.destroy()
                scheduler = null
                console.log('üí• Scheduler destroyed')
            }
            
            statusDiv.textContent = 'Components destroyed. Ready to start over.'
            
            // Reset button states
            fetchConfigBtn.disabled = false
            initBtn.disabled = true
            startSchedulerBtn.disabled = true
            evaluateBtn.disabled = true
            playBtn.disabled = true
            pauseBtn.disabled = true
            stopSchedulerBtn.disabled = true
            
            updateStatus()
        }

        // Clear debug log
        function clearLog() {
            debugLogDiv.textContent = ''
        }

        // Event listeners
        fetchConfigBtn.addEventListener('click', fetchConfiguration)
        initBtn.addEventListener('click', initializeComponents)
        startSchedulerBtn.addEventListener('click', startScheduler)
        evaluateBtn.addEventListener('click', evaluateSchedules)
        playBtn.addEventListener('click', playPlayer)
        pauseBtn.addEventListener('click', pausePlayer)
        stopSchedulerBtn.addEventListener('click', stopScheduler)
        destroyBtn.addEventListener('click', destroyAll)
        clearLogBtn.addEventListener('click', clearLog)

        // Allow Enter key in screen ID input
        screenIdInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                fetchConfiguration()
            }
        })

        // Initialize display
        updateStatus()
        
        // Welcome message
        console.log('üöÄ Phase 1 Demo Loaded: Real API Integration Testing')
        console.log(`üì° Environment: ${window.location.hostname}`)
        console.log(`üîó Publisher API: ${SCREENWERK_PUBLISHER_API}`)
        console.log('üëÜ Enter a screen ID and click "Fetch Live Config" to begin!')
    </script>
        
        console.error = function(...args) {
            originalError.apply(console, args)
            addToLog(args.join(' '), true)
        }
        
        // Test layout data
        const testLayout = {
            id: 'test_layout_001',
            name: 'Test Layout',
            width: 800,
            height: 450,
            regions: [
                {
                    id: 'region_1',
                    left: 10,
                    top: 10,
                    width: 380,
                    height: 200,
                    zindex: 1,
                    playlist: {
                        id: 'playlist_1',
                        name: 'Top Left Playlist',
                        media: [
                            { id: 'media_1', name: 'Image 1', type: 'Image', duration: 5 },
                            { id: 'media_2', name: 'Image 2', type: 'Image', duration: 7 }
                        ]
                    }
                },
                {
                    id: 'region_2',
                    left: 410,
                    top: 10,
                    width: 380,
                    height: 200,
                    zindex: 1,
                    playlist: {
                        id: 'playlist_2',
                        name: 'Top Right Playlist',
                        media: [
                            { id: 'media_3', name: 'Video 1', type: 'Video', duration: 10 }
                        ]
                    }
                },
                {
                    id: 'region_3',
                    left: 10,
                    top: 230,
                    width: 780,
                    height: 200,
                    zindex: 2,
                    playlist: {
                        id: 'playlist_3',
                        name: 'Bottom Full Width',
                        media: [
                            { id: 'media_4', name: 'Banner Image', type: 'Image', duration: 8 }
                        ]
                    }
                }
            ]
        }
        
        function updatePlayerState() {
            if (player) {
                const state = player.getState()
                playerStateDiv.textContent = JSON.stringify(state, null, 2)
            } else {
                playerStateDiv.textContent = 'Not initialized'
            }
        }
        
        function updateSchedulerState() {
            if (scheduler) {
                const state = scheduler.getState()
                schedulerStateDiv.textContent = JSON.stringify(state, null, 2)
            } else {
                schedulerStateDiv.textContent = 'Not initialized'
            }
        }
        
        function updateUI() {
            updatePlayerState()
            updateSchedulerState()
            
            const playerExists = !!player && !player.destroyed
            const schedulerExists = !!scheduler && !scheduler.destroyed
            
            initBtn.disabled = playerExists && schedulerExists
            loadLayoutBtn.disabled = !playerExists
            playBtn.disabled = !playerExists || (player && player.isPlaying)
            pauseBtn.disabled = !playerExists || (player && !player.isPlaying)
            destroyBtn.disabled = !playerExists && !schedulerExists
        }
        
        // Event handlers
        initBtn.addEventListener('click', () => {
            try {
                console.log('üîß Initializing Player + Scheduler...')
                
                // Create player
                player = new ScreenWerkPlayer(playerContainer)
                console.log('‚úÖ Player created')
                
                // Create scheduler (mock configuration)
                scheduler = new LayoutScheduler({
                    configurationId: 'test_config_001',
                    onLayoutChange: (layout) => {
                        console.log('üì± Scheduler sending layout to player:', layout.name)
                        if (player && !player.destroyed) {
                            const success = player.loadLayout(layout)
                            if (success) {
                                console.log('‚úÖ Player loaded layout successfully')
                            } else {
                                console.error('‚ùå Player failed to load layout')
                            }
                        }
                    }
                })
                console.log('‚úÖ Scheduler created')
                
                statusDiv.textContent = 'Player + Scheduler initialized successfully!'
                updateUI()
                
            } catch (error) {
                console.error('Failed to initialize:', error)
                statusDiv.textContent = `Initialization failed: ${error.message}`
            }
        })
        
        loadLayoutBtn.addEventListener('click', () => {
            if (player) {
                console.log('üìÑ Loading test layout...')
                const success = player.loadLayout(testLayout)
                statusDiv.textContent = success ? 'Test layout loaded!' : 'Failed to load layout'
                updateUI()
            }
        })
        
        playBtn.addEventListener('click', () => {
            if (player) {
                const success = player.play()
                statusDiv.textContent = success ? 'Playback started!' : 'Failed to start playback'
                updateUI()
            }
        })
        
        pauseBtn.addEventListener('click', () => {
            if (player) {
                const success = player.pause()
                statusDiv.textContent = success ? 'Playback paused!' : 'Failed to pause playback'
                updateUI()
            }
        })
        
        destroyBtn.addEventListener('click', () => {
            if (scheduler) {
                scheduler.destroy()
                scheduler = null
                console.log('üóëÔ∏è Scheduler destroyed')
            }
            
            if (player) {
                player.destroy()
                player = null
                console.log('üóëÔ∏è Player destroyed')
            }
            
            statusDiv.textContent = 'Player + Scheduler destroyed'
            updateUI()
        })
        
        clearLogBtn.addEventListener('click', () => {
            debugLogDiv.textContent = ''
        })
        
        // Initialize UI state
        updateUI()
        
        // Welcome message
        console.log('üéâ Clean Player Architecture Demo Loaded')
        console.log('üèóÔ∏è Modern ES6+ two-service architecture')
        console.log('üì± Player: Pure content rendering')
        console.log('üìÖ Scheduler: Configuration and timing')
        console.log('‚ú® Ready for testing!')
    </script>
</body>
</html>
